<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="swiss.css" type="text/css" />
</head>
<body>
<h2 id="framing">Framing</h2>
<p>The server may send responses out of order w.r.t. to requests.</p>
<pre><code>Message := Header Body;

Header := Type RestOfHeader;

Type := byte {
    REQUEST = 1,
    RESPONSE = 2,
    STREAM_BEGIN = 3,
    STREAM_MESSAGE = 4,
    STREAM_CLOSE = 5,
    REQUEST_ERRONLY = 6
};

RestOfHeader := byte[48];
// Interpretation of RestOfHeader depends on the Type.

Body := byte[];
// Body bytes are protobuf encoded and may be 0 length (empty).

BodyLen := uint32;

RqId := uint16;
// A unique request number generated by the client.

StreamId := uint16;

pad16 := byte[16]; // 16 bytes of padding, all zero.
pad32 := byte[32]; // 32 bytes of padding, all zero.</code></pre>
<h3 id="message-types">Message Types</h3>
<pre><code>REQUEST := RqID BodyLen;
    // A request always is paired with a single response.

RESPONSE := RqID BodyLen;

STREAM_BEGIN := StreamID RqId pad16;
    // Servers MUST send their STREAM_BEGIN messages before the
    // associated RESPONSE is sent.
    // Streams are explicit in the framing layer so that a
    // relay / proxy layer can pair streams to clients.

STREAM_MESSAGE := StreamID BodyLen;

STREAM_CLOSE := StreamID pad32;

REQUEST_ERRONLY := RqID BodyLen;
    // Only response to a REQUEST_ERRONLY will be an error.</code></pre>
<h3 id="todo">TODO</h3>
<p>Perhaps require that RqID is smaller than some size so proxies can do non-tabling client-request pairing for these, since they may not have responses and can't be cleaned out?</p>
<p>How should a proxy handle REQUEST_ERRONLY?</p>
</body>
</html>
